<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./app.css">
</head>
<body>

<div v-scope v-cloak>
    <div v-if="sgroup">
        <a href=".">Accueil</a> &gt;
        <span v-for="(parent, i) in sgroup.parents">
            <span v-scope="SgroupLink(parent)"></span>
            <span v-if="i < sgroup.parents.length">&gt;</span>
        </span>

        <h2>
            <span class="my-icon" v-html="sgroup.stem ? svg.folder : svg.users"></span>
            {{sgroup.ou}}
        </h2>

        <fieldset>
            <legend><h4>Description</h4></legend>
            <div class="description">{{sgroup.description}}</div>
        </fieldset>

        <p></p>
        <fieldset>
            <legend v-scope="LegendChoices(choice, setChoice, sgroup)"></legend>
            <div v-if="choice === 'rights'">
                <span v-if="sgroup.stem">
                    Les entités ayant des privilèges sur ce dossier <b>et tous les sous-dossiers et sous-groupes</b>
                </span>
                <span v-else>
                    Les entités ayant des privilèges sur ce groupe
                </span>
                <div v-if="rights">
                  <div v-if="empty(rights)"> <p></p> <i>Aucun</i> </div>
                  <div v-for="(subjects, right) in rights">
                    <h5>Droit "{{right2text[right]}}"</h5>
                    <ul>
                        <li v-for="(subject, dn) in subjects">
                            <span v-scope="SubjectOrGroup(dn, subject)"></span>
                            <button @click="remove_direct_mright(dn, right)">Supprimer</button>
                        </li>
                    </ul>
                  </div>
                </div>
            </div>
            <ul v-else-if="sgroup.stem">
                <div v-if="empty(sgroup.stem.children)"> <p></p> <i>Vide</i> </div>
                <li v-scope="SgroupLink(attrs, id)" v-for="(attrs, id) in sgroup.stem.children">
                    <span class="my-icon" v-html="svg.folder"></span>
                </li>
            </ul>
            <div v-else-if="sgroup.group">
                <div style="height: 1rem"></div>

                <div v-if="showAddMember">
                    Recherchez un utilisateur/groupe/... <button @click="showAddMember = false">fermer</button> <br>
                    <form @submit.prevent="addMember_search">
                        <input class="search_token" v-model="addMember_search_token">
                    </form>
                    <fieldset v-if="addMember_search_results">
                        <legend>Résultats de recherche</legend>
                        <ul>
                            <li v-for="(subjects, ss) in addMember_search_results">
                                <span v-if="!empty(subjects)">
                                    <span class="ss_name">{{sscfg.find(z => z.dn === ss).name}}</span>
                                    <ul>
                                        <li v-for="(subject, dn) in subjects">
                                            <span v-scope="SubjectOrGroup(dn, subject)"></span>
                                            <button @click="add_direct_mright(dn, 'member')">Ajouter</button>
                                        </li>
                                    </ul>
                                </span>
                            </li>
                        </ul>
                    </fieldset>
                </div>
                <button @click="showAddMember = true" v-else>Ajouter des membres</button>
                <button @click="showIndirect = !showIndirect; updateMembers()">{{showIndirect ? "Cacher les indirects" : "Voir les indirects"}}</button>

                <div style="height: 1rem"></div>

                <div v-if="!members">Veuillez patentier...</div>
                <div v-else-if="!members.count"> <p></p> <i>Aucun</i> </div>
                <div v-else-if="members">
                    Nb : {{members?.count}}
                    <ul>
                        <li v-for="(attrs, dn) in members?.subjects">
                            <span v-scope="SubjectOrGroup(dn, attrs)"></span>
                            <i v-if="showIndirect && attrs.indirect">Indirect</i>
                            <button @click="remove_direct_mright(dn, 'member')">Supprimer</button>
                        </li>
                    </ul>
                </div>
            </div>
        </fieldset>


        <p><i>Mes droits sur ce groupe : {{right2text[sgroup.right]}}</i></p>

    </div>
</div>

<script type="module">

import forEach from 'lodash/forEach'
import { createApp, reactive } from 'petite-vue'
import { api_get, api_post, searchParams, create_dynamic_template, to_valid_DOM_id, prepare_SgroupLink, svg, right2text } from './lib.js'

const SgroupLink = prepare_SgroupLink()

const Subject = (dn, subject, sscfg) => {
    const subject_cfg = sscfg.find(one => dn.endsWith(one.dn))
    const $template = '#' + to_valid_DOM_id(subject_cfg.dn)
    return { ...subject, $template }
}

const prepare_LegendChoices = () => {
    const $template = create_dynamic_template('LegendChoices', `
        <label @click="setChoice('direct')"><input type="radio" name="legend_choices" value='direct' v-model="choice">{{sgroup.group ? "Membres" : "Contenu du dossier"}}</label>
        <label @click="setChoice('rights')"><input type="radio" name="legend_choices" value='rights' v-model="choice">Privilèges</label>
    `)
    return (choice, setChoice, sgroup) => ({
        choice, setChoice, $template
    })
}

const prepare_SubjectOrGroup = (sscfg) => {
    const $template = create_dynamic_template('SubjectOrGroup', `
        <span v-if="attrs.sgroup_id" v-scope="SgroupLink(attrs)">
            <span class="my-icon" v-html="svg.folder"></span>
        </span>
        <span v-else v-scope="Subject(dn, attrs, sscfg)">
            <span class="my-icon" v-html="svg.user"></span>
        </span>
    `)
    return (dn, attrs) => ({
        $template,
        Subject, SgroupLink,
        sscfg, svg,
        dn, attrs,
    })
}

const compute_default_vue_template = (one) => (
    one.display_attrs.map((attr, i) =>
        `<span ${i ? "v-else-if" : "v-if"}="${attr}">{{${attr}}}</span>`
    ).join('')
)

function create_subject_sources_templates(sscfg) {
    for (const one of sscfg) {
        const template = one.vue_template || compute_default_vue_template(one)
        create_dynamic_template(one.dn, template)
    }
}
const id = searchParams().get('id')
api_get("config/subject_sources").then(async sscfg => {
    create_subject_sources_templates(sscfg)
    const sgroup = await api_get("sgroup", { id })

    const o = reactive({
        Subject, SgroupLink, SubjectOrGroup: prepare_SubjectOrGroup(sscfg), LegendChoices: prepare_LegendChoices(),
        svg, right2text,
        empty(o) { return Object.keys(o).length === 0 },

        sgroup, sscfg,
        rights: undefined,

        showAddMember: false, addMember_search_token: '', addMember_search_results: undefined,

        members: undefined, flat_members: undefined,
        showIndirect: false,
        async addMember_search() {
            this.addMember_search_results = await api_get('search_subjects', { search_token: this.addMember_search_token, sizelimit: 10 })
        },

        choice: undefined,
        updateSgroup() {
            api_get('sgroup', { id }).then(sgroup => {
                this.sgroup = sgroup
                this.updateMembers()
            })
        },
        updateRights() {
            this.rights = undefined
            api_get('sgroup_direct_rights', { id }).then(r => this.rights = r)
        },
        initChoice() {
            this.choice = document.location.hash.match(/^#(.*)/)?.[1] || 'direct'
            if (this.choice === 'rights') this.updateRights()
        },
        setChoice(what) {
            document.location.hash = "#" + what
        },

        async searchFlatMembers() {
            const r = await api_get('group_flattened_mright', { id, mright: 'member' })
            forEach(r.subjects, (attrs, dn) => {
                attrs.indirect = !(dn in this.sgroup.group?.direct_members)
            })
            this.flat_members = r
        },

        updateMembers() {
            if (this.showIndirect && !this.flat_members) {
                this.searchFlatMembers().then(_ => this.updateMembers())
            }
            let direct_members = this.sgroup.group?.direct_members
            this.members = this.showIndirect ? this.flat_members : this.sgroup.group ? { count: Object.keys(direct_members).length, subjects: direct_members } : undefined
        },

        async add_direct_mright(dn, right) {
            await api_post("modify_members_or_rights", { id }, { [right]: { add: ['ldap:///' + dn] } })
            if (right === 'member') {
                this.members = undefined
                this.updateSgroup()
            } else {
                this.updateRights()
            }
        },

        async remove_direct_mright(dn, right) {
            await api_post("modify_members_or_rights", { id }, { [right]: { delete: ['ldap:///' + dn] } })
            if (right === 'member') {
                this.members = undefined
                this.updateSgroup()
            } else {
                this.updateRights()
            }
        },
    })
    o.initChoice()
    o.updateMembers()
    window.addEventListener('hashchange', () => o.initChoice())
    createApp(o).mount()
})

</script>

</body></html>
