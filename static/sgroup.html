<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">        
    <link rel="stylesheet" href="app.css">
</head>
<body>

<div v-scope v-cloak>
    <div v-if="sgroup">
        <a href=".">Accueil</a> &gt;
        <span v-for="(parent, i) in sgroup.parents">
            <span v-scope="SgroupLink(parent)"></span>
            <span v-if="i < sgroup.parents.length">&gt;</span>
        </span>

        <h2>
            <span class="my-icon" v-html="sgroup.stem ? svg.folder : svg.users"></span>
            {{sgroup.ou}}
        </h2>

        <fieldset>
            <legend><h4>Description</h4></legend>
            <div class="description">{{sgroup.description}}</div>
        </fieldset>

        <p></p>
        <fieldset>
            <legend v-scope="LegendChoices(choice, setChoice, sgroup)"></legend>
            <div v-if="choice === 'rights'">
                <span v-if="sgroup.stem">
                    Les entités ayant des privilèges sur ce dossier <b>et tous les sous-dossiers et sous-groupes</b>
                </span>
                <span v-else>
                    Les entités ayant des privilèges sur ce groupe
                </span>
                <div v-if="rights">
                  <div v-if="empty(rights)"> <p></p> <i>Aucun</i> </div>
                  <div v-for="(subjects, right) in rights">
                    <h5>{{right2text[right]}}</h5>
                    <ul>
                        <li v-for="(subject, dn) in subjects">
                            <span v-scope="SubjectOrGroup(dn, subject)"></span>
                        </li>
                    </ul>
                  </div>
                </div>
            </div>
            <ul v-else-if="sgroup.stem">
                <div v-if="empty(sgroup.stem.children)"> <p></p> <i>Vide</i> </div>
                <li v-scope="SgroupLink(attrs, id)" v-for="(attrs, id) in sgroup.stem.children">
                    <span class="my-icon" v-html="svg.folder"></span>
                </li>
            </ul>    
            <ul v-else-if="sgroup.group">
                <div v-if="empty(sgroup.group.direct_members)"> <p></p> <i>Aucun</i> </div>
                <li v-for="(attrs, dn) in sgroup.group.direct_members">
                    <span v-scope="SubjectOrGroup(dn, attrs)"></span>
                </li>
            </ul>               
        </fieldset>

        <p><i>Mes droits sur ce groupe : {{right2text[sgroup.right]}}</i></p>

    </div>
</div>

<script type="module">

import { createApp, reactive } from '././node_modules/petite-vue'
import { api, searchParams, create_dynamic_template, to_valid_DOM_id, prepare_SgroupLink, svg, right2text } from './lib.js'

const SgroupLink = prepare_SgroupLink()

const Subject = (dn, subject, sscfg) => {
    const subject_cfg = sscfg.find(one => dn.endsWith(one.dn))
    const $template = '#' + to_valid_DOM_id(subject_cfg.dn)
    return { ...subject, $template }
}

const prepare_LegendChoices = () => {
    const $template = create_dynamic_template('LegendChoices', `
        <label @click="setChoice('direct')"><input type="radio" name="legend_choices" value='direct' v-model="choice">{{sgroup.group ? "Membres directs" : "Contenu du dossier"}}</label> 
        <label @click="setChoice('rights')"><input type="radio" name="legend_choices" value='rights' v-model="choice">Privilèges</label>
    `)
    return (choice, setChoice, sgroup) => ({
        choice, setChoice, $template
    })
}

const prepare_SubjectOrGroup = (sscfg) => {
    const $template = create_dynamic_template('SubjectOrGroup', `
        <span v-if="attrs.sgroup_id" v-scope="SgroupLink(attrs)">
            <span class="my-icon" v-html="svg.folder"></span>
        </span>
        <span v-else v-scope="Subject(dn, attrs, sscfg)">
            <span class="my-icon" v-html="svg.user"></span>
        </span>
    `)
    return (dn, attrs) => ({
        $template,
        Subject, SgroupLink,
        sscfg, svg,
        dn, attrs,
    })
}

const compute_default_vue_template = (one) => (
    one.display_attrs.map((attr, i) => 
        `<span ${i ? "v-else-if" : "v-if"}="${attr}">{{${attr}}}</span>`
    ).join('')
)

function create_subject_sources_templates(sscfg) {
    for (const one of sscfg) {
        const template = one.vue_template || compute_default_vue_template(one)
        create_dynamic_template(one.dn, template)
    }
}
const id = searchParams().get('id')
const sscfg = await api("config/subject_sources")
create_subject_sources_templates(sscfg)

api("sgroup", { id }).then(async sgroup => {
    const o = reactive({ 
        Subject, SgroupLink, SubjectOrGroup: prepare_SubjectOrGroup(sscfg), LegendChoices: prepare_LegendChoices(),
        svg, right2text,
        empty(o) { return Object.keys(o).length === 0 },

        sgroup, sscfg,
        rights: undefined,

        choice: undefined,
        initChoice() {
            this.choice = document.location.hash.match(/^#(.*)/)?.[1] || 'direct'
            if (this.choice === 'rights') {
                this.rights = undefined
                api('sgroup_direct_rights', { id }).then(r => this.rights = r)
            }
        },
        setChoice(what) {
            document.location.hash = "#" + what
        },
    })
    o.initChoice()
    window.addEventListener('hashchange', () => o.initChoice())
    createApp(o).mount()
})

</script>

</body></html>
